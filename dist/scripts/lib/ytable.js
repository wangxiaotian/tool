!function(t){jQuery(function(a){var e=function(){};e.prototype.defaultOptions={container:"",batchable:!1,url:"",urlParams:{},cols:[],operations:[],filterForm:"",filterButton:"",page:{page:1,size:10,total:100},filter:{},rawData:[],renderData:{thData:{},trData:{},batchable:!1},headerHtml:""},e.prototype.init=function(t){var e=this;a.extend(!0,this,e.defaultOptions,t),e.loadInfo(),e.initFrame(),e.initTable(function(){e.initPaginate()}),e.initBatchEvent(),e.initFilter(),a(window).on("unload",function(){e.saveInfo()})},e.prototype.loadInfo=function(){var a=this,e=t.getSessionData(location.href+a.container);e&&(e.page&&(a.page=e.page),e.filter&&(a.filter=e.filter),t.setSessionData(location.href+a.container,{}))},e.prototype.saveInfo=function(a){if(a)return void t.setSessionData(location.href+e.container,{});var e=this;"string"==typeof e.filter&&(e.filter=t.deparam(e.filter));var n={filter:e.filter,page:e.page};t.setSessionData(location.href+e.container,n)},e.prototype.initFrame=function(){var t=this,e='<div class="dataTables_wrapper form-inline no-footer">                                <div class="ytable-table"></div>                                <div class="ytable-page"></div>                            </div>';a(t.container).html(e)},e.prototype.initTable=function(t){var e=this;e.getData(function(n){e.dealData(),e.dealOperations(),e.render(function(){e.decideOperationShow(),a(e.container).trigger("updated"),t&&t()})})},e.prototype.updateTable=function(t){var e=this;e.getData(function(n){e.dealData(),e.render(function(){e.decideOperationShow(),a(e.container).trigger("updated"),t&&t()})})},e.prototype.initFilter=function(){var e=this,n=a(e.filterForm),i=a(e.filterButton);n<=0||i<=0||(i.on("click",function(t){t.preventDefault(),a(e.filterForm).find("input[type=text]").each(function(){a(this).val(a.trim(a(this).val()))});var n=a(e.filterForm).serialize();e.doFilter(n)}),setTimeout(function(){for(var n in e.filter)a('[name="'+n+'"]').val(e.filter[n]),function(e){a('[name="'+n+'"]').on("rendered",function(){return!!t.selectorHasValue(a(this),e)&&(a(this).val(e),void a(this).trigger("change"))})}(e.filter[n])},0))},e.prototype.doFilter=function(t,a){var e=this;e.filter=t,e.page.page=1,e.updateTable(function(){e.updatePaginate(),a&&a()})},e.prototype.batch=function(t){var e=this,n=[];a(e.container).find("tbody tr").each(function(t,i){a(i).hasClass("active")&&n.push(e.rawData[t])}),t&&t(n)},e.prototype.render=function(e){var n=this;t.requireTmpl("widgets/ytable/table",function(i){t.render({context:a(n.container).find(".ytable-table"),data:n.renderData,tmpl:i,overwrite:!0}),"function"==typeof e&&e()})},e.prototype.getData=function(e){var n=this,i={page:n.page.page,size:n.page.size};"string"==typeof n.filter&&(n.filter=t.deparam(n.filter));var o=a.extend(o,n.urlParams);o=a.extend({},o,i,n.filter),t.getData(n.url,o,function(a){if(0!==a.status)return void t.alert(a.message?a.message:"请求数据失败");if(e)return n.rawData=a.data,n.page.total=a.total,n.rawData.length<=0&&n.page.page>1?(n.page.page--,void n.getData(e)):void e(a.data)})},e.prototype.dealData=function(e){var n=this,i=[],o=[];a.each(n.cols,function(t,a){var e=n.getValue(a.alias);i.push(e)}),a.each(n.rawData,function(e,i){var r=[];a.each(n.cols,function(a,e){var n=i[e.name];n=t.escape(n),e.display?r.push(e.display(n,i)):r.push(n)}),o.push(r)}),n.renderData.thData=i,n.renderData.trData=o},e.prototype.dealOperations=function(){var t=this;t.renderData.operations="",a.each(t.operations,function(e,n){var i=n.color||"primary",o='<a href="javascript:;" class="ytable-opera ytable-opera-'+i+" ytable-opera-"+e+'">'+n.name+"</a>";a(t.container).on("click",".ytable-opera-"+e,function(){var e=a(this).closest("tr").index();n.todo(t.rawData[e])}),t.renderData.operations+=o}),t.renderData.batchable=t.batchable},e.prototype.decideOperationShow=function(){var t=this;a.each(t.rawData,function(e,n){var i=a(t.container).find("tbody tr").eq(e);a.each(t.operations,function(t,a){if("function"==typeof a.isShow){var e=i.find(".ytable-opera").eq(t);a.isShow(n)||e.hide()}})}),a(".ytable-opera")},e.prototype.getValue=function(t){return"function"==typeof t?t():t},e.prototype.initBatchEvent=function(){var t=this,e="active";a(t.container).on("click","thead > tr > th input[type=checkbox]",function(){var t=this.checked;a(this).closest("table").find("tbody > tr").each(function(){var n=this;t?a(n).addClass(e).find("input[type=checkbox]").eq(0).prop("checked",!0):a(n).removeClass(e).find("input[type=checkbox]").eq(0).prop("checked",!1)})}),a(t.container).on("click","td input[type=checkbox]",function(){var t=a(this).closest("tr");t.is(".detail-row ")||(this.checked?t.addClass(e):t.removeClass(e))})},e.prototype.initPaginate=function(){var e=this;t.requireTmpl("widgets/ytable/page",function(i){t.render({context:a(e.container).find(".ytable-page"),data:{},tmpl:i}),e.updatePaginate(),n.find(".ytalbe-table_length").val(e.page.size)});var n=a(e.container);n.on("click",".paginate_button .go",function(){var t=parseInt(n.find(".go-page").val()),a=Math.ceil(e.page.total/e.page.size);isNaN(t)||t<1?e.page.page=1:t>a?e.page.page=a:e.page.page=t,e.updateTable(function(){e.updatePaginate()})}),n.on("keydown",".go-page",function(t){if(console.log(t.keyCode),13===t.keyCode){var a=parseInt(n.find(".go-page").val()),i=Math.ceil(e.page.total/e.page.size);isNaN(a)||a<1?e.page.page=1:a>i?e.page.page=i:e.page.page=a,e.updateTable(function(){e.updatePaginate()})}}),n.on("click",".paginate_button.first",function(){a(this).hasClass("disabled")||(e.page.page=1,e.updateTable(function(){e.updatePaginate()}))}),n.on("click",".paginate_button.last",function(){a(this).hasClass("disabled")||(e.page.page=Math.ceil(e.page.total/e.page.size),e.updateTable(function(){e.updatePaginate()}))}),n.on("click",".paginate_button.previous",function(){a(this).hasClass("disabled")||(e.page.page-=1,e.updateTable(function(){e.updatePaginate()}))}),n.on("click",".paginate_button.next",function(){a(this).hasClass("disabled")||(e.page.page+=1,e.updateTable(function(){e.updatePaginate()}))}),n.on("click",".js-paginate-btn",function(){e.page.page=parseInt(a(this).text()),e.updateTable(function(){e.updatePaginate()})}),n.on("change",".ytalbe-table_length",function(){var t=a(this).val();e.page.size=parseInt(t),e.page.page=1,e.updateTable(function(){e.updatePaginate()})})},e.prototype.update=function(){var t=this;a(t.container);t.updateTable(function(){t.updatePaginate()})},e.prototype.updatePaginate=function(){var t=this,e=t.page.page,n=t.page.size,i=t.page.total,o=Math.ceil(i/n),r=1,p=(e-1)*n+1,l=p+n-1;l>i&&(l=i),p>i&&(p=i),p<0&&(p=0===i?0:1),e>o&&(e=o);var c=a(t.container);c.find(".paginate_button").removeClass("disabled"),e<=r&&(c.find(".paginate_button.first").addClass("disabled"),c.find(".paginate_button.previous").addClass("disabled")),e>=o&&(c.find(".paginate_button.last").addClass("disabled"),c.find(".paginate_button.next").addClass("disabled"));var s=5,d=Math.ceil(i/n),u=e-1-(e-1)%s,f=u+1,g=u+s,h="";g=g<d?g:d;for(var v=f;v<=g;v++)h+=v===e?'<li class="paginate_button pagination_num js-paginate-btn active"><a href="javascript:;">'+v+"</a></li>":'<li class="paginate_button pagination_num js-paginate-btn"><a href="javascript:;">'+v+"</a></li>";c.find(".pagination_num").remove(),c.find(".paginate_button.previous").after(h),a(t.container).find(".ytable-paginate-info").html("显示第 "+p+" 到 "+l+" 条， 共"+i+"条数据, 共"+o+"页"),a(t.container).find(".go-page").val(t.page.page)},e.prototype.on=function(t,e){var n=this;a(n.container).on(t,e)},window.ytable={create:function(t){var a=new e;return a.init(t),a}}})}(Utils);